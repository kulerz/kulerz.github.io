<!DOCTYPE html>
<html>
<head>
    <title>扫雷游戏 mineSweep by kulerz</title>
    <meta charset="utf-8"/>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            background: #245a93;
        }

        #mineSweep {
            width: 270px;
            margin: 0 auto;
        }

        #mineLevel {
            width: 300px;
            height: auto;
            color: white;
            margin: 0 auto;
            text-align: center;
        }

        #mineLevel p {
            font-size: 13px;
        }

        #button {
            width: 100%;
            margin: 10px auto;
        }

        #mineAreaDown {
            width: 100%;
            background: lightblue;
        }

        #mineAreaUp {
            width: 100%;
            position: relative;
            top: -270px;
        }

        .mines, .mined, .hide, .mark {
            background-color: aliceblue;
            display: block;
            float: left;
            text-align: center;
            line-height: 26px;
            font-size: 12px;
        }

        .mines {
            background-color: white;
            width: 28px;
            height: 28px;
            border: 1px solid silver;
        }

        .mined {
            width: 26px;
            height: 26px;
            border: 2px solid;
            border-color: silver #245a93 #245a93 silver;
        }

        .hide {
            width: 30px;
            height: 30px;
            opacity: 0;
        }

        .mark {
            width: 26px;
            height: 26px;
            border: 2px solid;
            border-color: silver #245a93 #245a93 silver;
            background-color: red;
        }

        li {
            list-style: none;
        }
    </style>
    <script type="text/javascript">
        //定义游戏格子总数 单行格子数目 地雷数量
        var level;
        var levelNum;
        var minesNum;

        //创建游戏
        function CreateMine(gameLevel,numset) {
            level = gameLevel;
            minesNum = numset;
            levelNum = Math.sqrt(level);

            //清空界面
            document.getElementById('mineAreaDown').innerHTML = '';
            document.getElementById('mineAreaUp').innerHTML = '';

            //设置显示和难度
            document.getElementById('mineAreaUp').style.display = "block";
            document.getElementById('mineSweep').style.width = levelNum*30+'px';
            document.getElementById('mineAreaUp').style.top = -levelNum*30+'px';

            //清空提示
            document.getElementById('prompt').innerHTML = '<p>随便点几下，也许有好运气。</p>';

            //创建游戏界面
            for (var i=1; i<=level; i++) {
                //创建下层地雷
                var mineAreaDown = document.getElementById('mineAreaDown');
                var mines = document.createElement('span');
                mines.className = 'mines';
                mines.id = i;
                mineAreaDown.appendChild(mines);

                //创建上层按钮
                var mineAreaUp = document.getElementById('mineAreaUp');
                var mined = document.createElement('span');
                mined.className = 'mined';
                mined.id = "mined"+i;
                mined.markID = i;
                mineAreaUp.appendChild(mined);
                mined.addEventListener('mousedown', hideMine);
                mined.addEventListener('mousedown', check);
            }

            //创建地雷
            var mineExist = document.getElementsByTagName("li");
            for (i=0; i<minesNum*2; i++) {
                var mineNum = getRandom(1,level);
                var mine = document.getElementById(mineNum);

                if(mineExist.length==minesNum){
                    break;
                } else {
                    mine.innerHTML = '<li>地雷</li>';
                }
            }

            //根据地雷生成周围数字
            for (i=1; i<=level; i++) {
                var aroundNum = 0;
                //判断四个角周围的地雷
                if (i==1) {
                    for (var j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+1+levelNum) || mineExist[j].parentNode.id==(i+levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i==levelNum) {
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i-1+levelNum) || mineExist[j].parentNode.id==(i+levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i==level) {
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i-1-levelNum) || mineExist[j].parentNode.id==(i-levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i==(level-levelNum+1)) {
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+1-levelNum) || mineExist[j].parentNode.id==(i-levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                //判断四条边每个格子周围的地雷
                else if (i>1 && i<levelNum){
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i-1+levelNum) || mineExist[j].parentNode.id==(i+levelNum) || mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+1+levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i>(level-levelNum+1) && i<level){
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i-1-levelNum) || mineExist[j].parentNode.id==(i-levelNum) || mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+1-levelNum)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i>levelNum && i<(level-levelNum) && (i-1)%levelNum==0){
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-levelNum) || mineExist[j].parentNode.id==(i-levelNum+1) || mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+levelNum) || mineExist[j].parentNode.id==(i+levelNum+1)) {
                            aroundNum++;
                        }
                    }

                }

                else if (i>levelNum && i<(level-levelNum+1) && i%levelNum==0){
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-levelNum) || mineExist[j].parentNode.id==(i-levelNum-1) || mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i+levelNum) || mineExist[j].parentNode.id==(i+levelNum-1)) {
                            aroundNum++;
                        }
                    }

                }

                //判断中间部位每个格子周围的地雷
                else {
                    for (j=0; j<mineExist.length; j++) {
                        if (mineExist[j].parentNode.id==(i-levelNum) || mineExist[j].parentNode.id==(i-levelNum-1) || mineExist[j].parentNode.id==(i-levelNum+1) || mineExist[j].parentNode.id==(i-1) || mineExist[j].parentNode.id==(i+1) || mineExist[j].parentNode.id==(i+levelNum) || mineExist[j].parentNode.id==(i+levelNum-1) || mineExist[j].parentNode.id==(i+levelNum+1)) {
                            aroundNum++;
                        }
                    }

                }

                //写入地雷数目
                var num = document.getElementById(i);
                if (num.innerHTML!='<li>地雷</li>' && aroundNum!=0) {
                    num.innerHTML = aroundNum;
                }
            }
        }

        //随机数
        function getRandom(min,max) {
            return Math.floor(Math.random()*(max-min))+min;
        }

        //点击隐藏上层格子，显示下层格子内容
        function hideMine(e) {
            var mineClicked = document.getElementById(this.markID);

            //右键标记，已标记则取消
            if (e.buttons==2) {
                if (this.className==='mined') {
                    this.className = 'mark';
                } else if (this.className==='mark') {
                    this.className = 'mined';
                }
            }

            //左键打开格子
            if (e.buttons==1) {
                this.className = 'hide';
                this.removeEventListener('mousedown', hideMine);
                if (mineClicked.innerHTML=='<li>地雷</li>') {
                    document.getElementById(this.markID).style.color = 'red';
                    document.getElementById('prompt').innerHTML = '<p style="color: red">踩中地雷，游戏结束，请点击上方按钮重新开始。</p>';
                    document.getElementById('mineAreaUp').style.display = "none";
                } else if (mineClicked.innerHTML=='') {
                    this.className = 'hide';
                    this.removeEventListener('mousedown', hideMine);

                    //四个角
                    if (this.markID==1) {
                        var arr = [this.markID+1,this.markID+1+levelNum,this.markID+levelNum];
                    } else if (this.markID==levelNum) {
                        arr = [this.markID-1,this.markID-1+levelNum,this.markID+levelNum];
                    } else if (this.markID==level) {
                        arr = [this.markID-1,this.markID-1-levelNum,this.markID-levelNum];
                    } else if (this.markID==(level-levelNum+1)) {
                        arr = [this.markID+1,this.markID+1-levelNum,this.markID-levelNum];
                    }

                    //四条边
                    else if (this.markID>1 && this.markID<levelNum) {
                        arr = [this.markID+1,this.markID+1+levelNum,this.markID+levelNum,this.markID-1,this.markID-1+levelNum];
                    } else if (this.markID>(level-levelNum+1) && this.markID<level) {
                        arr = [this.markID-1,this.markID-1-levelNum,this.markID-levelNum,this.markID+1,this.markID+1-levelNum];
                    } else if (this.markID>levelNum && this.markID<(level-levelNum) && (this.markID-1)%levelNum==0) {
                        arr = [this.markID+1,this.markID+1-levelNum,this.markID+levelNum,this.markID+1+levelNum,this.markID-levelNum];
                    } else if (this.markID>levelNum && this.markID<(level-levelNum+1) && this.markID%levelNum==0) {
                        arr = [this.markID-1,this.markID-1-levelNum,this.markID-1+levelNum,this.markID+levelNum,this.markID-levelNum];
                    }

                    //中间区域
                    else {
                        arr = [this.markID-levelNum,this.markID+levelNum,this.markID-1+levelNum,this.markID-1-levelNum,this.markID+1+levelNum,this.markID+1-levelNum,this.markID+1,this.markID-1];
                    }

                    showRest(arr);
                }
            }
        }

        //点击空白格子时显示周围无地雷格子
        function showRest(arr) {
            for (var k=0; k<arr.length; k++) {
                if (document.getElementById(arr[k]).innerHTML!='<li>地雷</li>') {
                    document.getElementById('mined'+arr[k]).className = 'hide';
                    document.getElementById('mined'+arr[k]).removeEventListener('mousedown', hideMine);
                }
            }
        }

        //检查是否完成扫雷
        function check() {
            var hide = document.getElementsByClassName('hide');
            var mark = document.getElementsByClassName('mark');
            if (hide.length==level-minesNum && mark.length==minesNum) {
                document.getElementById('prompt').innerHTML = '<p>恭喜！扫雷成功！</p>';
                for (var i=0; i<mark.length; i++) {
                    mark[i].style.backgroundColor = 'green';
                    mark[i].removeEventListener('mousedown', hideMine);
                }
            }
        }

        //网页加载事件
        window.onload = function() {
            //初始化游戏
            CreateMine(81,10);
            //游戏区域不显示右键菜单
            document.body.oncontextmenu = function() {
                return false;
            };
        }


    </script>
</head>

<body>
<div id="mineLevel">
    <h4>扫雷游戏 mineSweep by kulerz</h4>
    <p>游戏规则:左键单击打开格子，右键标记地雷，打开所有安全格子标记所有地雷后成功，助你好运！</p>
    <div id="button">
        <input type="button" value="初级" onclick="CreateMine(81,10)">
        <input type="button" value="中级" onclick="CreateMine(256,40)">
        <input type="button" value="高级" onclick="CreateMine(484,99)">
        <input type="button" value="疯狂模式" onclick="CreateMine(1600,300)">
        <div id="prompt"></div>
    </div>
</div>
<div id="mineSweep">
    <div id="mineAreaDown"></div>
    <div id="mineAreaUp"></div>
</div>
</body>
</html>